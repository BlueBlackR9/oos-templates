FormatVersion: OOS-2019-06-01
Description: Schedules to reboot the ECS instances by specifying tag.
Parameters:
  cron:
    Description: "The cron expression\uFF0Crefer them here: https://www.alibabacloud.com/help/zh/faq-detail/64769.htm.\
      \ The minimum interval is one minute."
    Type: String
    MaxLength: 30
  endDate:
    Description: 'The end date of time trigger. Format: yyyy-MM-ddThh:mm:ssZ.'
    Type: String
  tagKey:
    Description: The tag key for query ECS instances.
    Type: String
    MinLength: 1
    MaxLength: 30
  tagValue:
    Description: The tag value for query ECS instances.
    Type: String
    MinLength: 1
    MaxLength: 30
  maxErrors:
    Description: The maximum number of errors allowed during task execution.
    Type: Number
    Default: 0
  concurrency:
    Description: Concurrency ratio of task execution.
    Type: Number
    Default: 1
  OOSAssumeRole:
    Description: The RAM role to be assumed by OOS.
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: timerTrigger
  Action: ACS::TimerTrigger
  Description: Triggers a task as scheduled by specifying Cron expression.
  Properties:
    Type: cron
    Expression: '{{ cron }}'
    EndDate: '{{ endDate }}'
- Name: describeRunningInstancesByTag
  Action: ACS::ExecuteAPI
  Description: Views the ECS instances by specifying tag.
  Properties:
    Service: ECS
    API: DescribeInstances
    Parameters:
      Status: Running
      Tags:
      - Key: '{{ tagKey }}'
        Value: '{{ tagValue }}'
  Outputs:
    instanceIds:
      Type: List
      ValueSelector: Instances.Instance[].InstanceId
- Name: rebootInstance
  Action: ACS::ECS::RebootInstance
  Description: Restarts the ECS instance by the instance ID.
  Properties:
    instanceId: '{{ ACS::TaskLoopItem }}'
  Loop:
    MaxErrors: '{{ maxErrors }}'
    Concurrency: '{{ concurrency }}'
    Items: '{{ describeRunningInstancesByTag.instanceIds }}'
Outputs:
  instanceIds:
    Type: List
    Value: '{{ describeRunningInstancesByTag.instanceIds }}'
