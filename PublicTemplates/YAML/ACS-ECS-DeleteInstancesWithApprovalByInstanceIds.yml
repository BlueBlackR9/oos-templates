FormatVersion: OOS-2019-06-01
Description: Deletes the ECS instances with approval.
Parameters:
  instanceIds:
    Description: The ID list of the ECS instance.
    Type: List
  accessToken:
    Description: Dingtalk access_token to be notified.
    Type: String
    AllowedPattern: '[A-Za-z0-9]*'
  maxErrors:
    Description: The maximum number of errors allowed during task execution.
    Type: Number
    Default: 0
  concurrency:
    Description: Concurrency ratio of task execution.
    Type: Number
    Default: 1
  OOSAssumeRole:
    Description: The RAM role to be assumed by OOS.
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: approvalForDeleteInstances
  Action: ACS::Approve
  Description: Approval to delete ECS instances.
  Properties:
    NotifyType: WebHook
    WebHook:
      URI: https://oapi.dingtalk.com/robot/send?access_token={{ accessToken }}
      Headers:
        Content-Type: application/json
      Content:
        msgtype: text
        text:
          content: The ECS instances({{ instanceIds }}) will be deleted
- Name: deleteInstance
  Action: ACS::ECS::DeleteInstance
  Description: Deletes the ECS instances.
  Properties:
    instanceId: '{{ ACS::TaskLoopItem }}'
  Loop:
    MaxErrors: '{{ maxErrors }}'
    Concurrency: '{{ concurrency }}'
    Items: '{{ instanceIds }}'
