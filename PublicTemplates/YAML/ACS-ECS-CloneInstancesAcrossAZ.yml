FormatVersion: OOS-2019-06-01
Description:
  en: Cross available zone copy and run ECS instance of same InstanceType by InstanceIds.
  zh-cn: 跨可用区克隆ECS实例。
  name-en: ACS-ECS-CloneInstancesAcrossAZ
  name-zh-cn: 跨可用区克隆ECS实例
Parameters:
  instanceIds:
    Description:
      en: The ID list of the ECS instance.
      zh_ch: ECS实例ID列表。
    Type: List
  regionId:
    Description:
      en: The Source Region Id.
      zh-cn: 地域ID。
    Type: String
    MinLength: 1
    MaxLength: 30
  targetZoneId:
    Description:
      en: The target Zone Id.
      zh-cn: 可用去ID。
    Type: String
    MinLength: 1
    MaxLength: 30
  targetSecurityGroupId:
    Description:
      en: The security group ID for the ECS instances, sg-xxxxxxxxxxxxxxxxxxxx, for example.
      zh-cn: '安全组ID。格式:sg-xxxxxxxxxxxxxxxxxxxx'
    Type: String
    AllowedPattern: 'sg-[A-Za-z0-9]*'
    MinLength: 1
    MaxLength: 30
  targetVSwitchId:
    Description:
      en: The virtual switch ID for the ECS instances, vsw-xxxxxxxxxxxxxxxxxxxx, for example.
      zh-cn: 交换机ID。
    Type: String
    AllowedPattern: 'vsw-[A-Za-z0-9]*'
    MinLength: 1
    MaxLength: 30
  OOSAssumeRole:
    Description:
      en: The RAM role to be assumed by OOS.
      zh-cn: OOS扮演的RAM角色。
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: queryInstancetype
    Action: 'ACS::ExecuteAPI'
    Description:
      en: Views the ECS instances' InstanceType.
      zh-cn: 获取实例类型。
    Properties:
      Service: ECS
      API: DescribeInstances
      Parameters:
        RegionId: '{{ regionId }}'
        InstanceIds: '{{ instanceIds }}'
    Outputs:
      instanceType:
        ValueSelector: Instances.Instance[0].InstanceType
        Type: String
  - Name: createImage
    Action: 'ACS::ExecuteAPI'
    Description:
      en: Create Image.
      zh-cn: 创建镜像。
    Properties:
      Service: ECS
      API: CreateImage
      Parameters:
        RegionId: '{{ regionId }}'
        ImageName: 'img-{{ ACS::TaskLoopItem }}-{{ACS::ExecutionId}}'
        InstanceId: '{{ ACS::TaskLoopItem }}'
    Loop:
      Items: '{{ instanceIds }}'
      Outputs:
        ImageIds:
          AggregateType: 'Fn::ListJoin'
          AggregateField: ImageId
    Outputs:
      ImageId:
        ValueSelector: ImageId
        Type: String
  - Name: untilCreateImageReady
    Action: 'ACS::WaitFor'
    Description:
      en: Wait for created images available.
      zh-cn: 等待镜像创建成功。
    Properties:
      Service: ECS
      API: DescribeImages
      Parameters:
        RegionId: '{{ regionId }}'
        ImageId: '{{ ACS::TaskLoopItem }}'
      DesiredValues:
        - Available
      PropertySelector: 'Images.Image[].Status'
    Loop:
      Items: '{{ createImage.ImageIds }}'
  - Name: runInstances
    Action: 'ACS::ExecuteAPI'
    Description:
      en: Run Instances.
      zh-cn: 创建实例。
    Properties:
      Service: ECS
      API: RunInstances
      Parameters:
        RegionId: '{{ regionId }}'
        ZoneId: '{{ targetZoneId }}'
        ImageId: '{{ ACS::TaskLoopItem }}'
        InstanceType: '{{ queryInstancetype.instanceType }}'
        SecurityGroupId: '{{ targetSecurityGroupId }}'
        VSwitchId: '{{ targetVSwitchId }}'
    Loop:
      Items: '{{ createImage.ImageIds }}'
      Outputs:
        instanceIds:
          AggregateType: 'Fn::ListJoin'
          AggregateField: instanceId
    Outputs:
      instanceId:
        Type: String
        ValueSelector: 'InstanceIdSets.InstanceIdSet[]'
  - Name: untilInstanceReady
    Action: 'ACS::WaitFor'
    Description:
      en: Wait for instances running.
      zh-cn: 等待实例到Running状态。
    Properties:
      Service: ECS
      API: DescribeInstances
      Parameters:
        RegionId: '{{ regionId }}'
        InstanceIds: '{{ runInstances.instanceIds }}'
      DesiredValues:
        - Running
      PropertySelector: 'Instances.Instance[].Status'
Outputs:
  instanceIds:
    Value: '{{ runInstances.instanceIds }}'
    Type: List