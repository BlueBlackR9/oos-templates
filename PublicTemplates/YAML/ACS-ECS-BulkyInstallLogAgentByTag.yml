FormatVersion: OOS-2019-06-01
Description: Installs SLS agent on ECS instances by specifying tag.
Parameters:
  logTailUserDefinedId:
    Description: The user defined Id write to /etc/ilogtail/user_defined_id.
    Type: String
    MaxLength: 30
    MinLength: 1
  tagKey:
    Description: The tag key for query ECS instances.
    Type: String
    MinLength: 1
    MaxLength: 30
  tagValue:
    Description: The tag value for query ECS instances.
    Type: String
    MinLength: 1
    MaxLength: 30
  maxErrors:
    Description: The maximum number of errors allowed during task execution.
    Type: Number
    Default: 0
  concurrency:
    Description: Concurrency ratio of task execution.
    Type: Number
    Default: 1
  OOSAssumeRole:
    Description: The RAM role to be assumed by OOS.
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: describeRunningInstancesByTag
  Action: ACS::ExecuteAPI
  Description: Views the ECS instances by specifying tag.
  Properties:
    Service: ECS
    API: DescribeInstances
    Parameters:
      Status: Running
      Tags:
      - Key: '{{ tagKey }}'
        Value: '{{ tagValue }}'
  Outputs:
    instanceIds:
      Type: List
      ValueSelector: Instances.Instance[].InstanceId
- Name: installAgent
  Action: ACS::ECS::InstallLogtail
  Description: Install agent on the ECS instance.
  Properties:
    logTailUserDefinedId: '{{ logTailUserDefinedId }}'
    instanceId: '{{ ACS::TaskLoopItem }}'
  Loop:
    MaxErrors: '{{ maxErrors }}'
    Concurrency: '{{ concurrency }}'
    Items: '{{ describeRunningInstancesByTag.instanceIds }}'
