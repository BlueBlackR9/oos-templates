FormatVersion: OOS-2019-06-01
Description: Run command on ECS instances by specifying tag.
Parameters:
  commandContent:
    Description: Command content to run in ECS instance.
    Type: String
  tagKey:
    Description: The tag key for query ECS instances.
    Type: String
    MinLength: 1
    MaxLength: 30
  tagValue:
    Description: The tag value for query ECS instances.
    Type: String
    MinLength: 1
    MaxLength: 30
  commandType:
    Description: The type of command.
    Type: String
    AllowedValues:
    - RunBatScript
    - RunPowerShellScript
    - RunShellScript
  maxErrors:
    Description: The maximum number of errors allowed during task execution.
    Type: Number
    Default: 0
  concurrency:
    Description: Concurrency ratio of task execution.
    Type: Number
    Default: 1
  OOSAssumeRole:
    Description: The RAM role to be assumed by OOS.
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: describeRunningInstancesByTag
  Action: ACS::ExecuteAPI
  Description: Views the ECS instances by specifying tag.
  Properties:
    Service: ECS
    API: DescribeInstances
    Parameters:
      Status: Running
      Tags:
      - Key: '{{ tagKey }}'
        Value: '{{ tagValue }}'
  Outputs:
    instanceIds:
      Type: List
      ValueSelector: Instances.Instance[].InstanceId
- Name: runCommand
  Action: ACS::ECS::RunCommand
  Description: Invokes ECS instance command.
  Properties:
    commandContent: '{{ commandContent }}'
    instanceId: '{{ ACS::TaskLoopItem }}'
    commandType: '{{ commandType }}'
  Loop:
    MaxErrors: '{{ maxErrors }}'
    Concurrency: '{{ concurrency }}'
    Items: '{{ describeRunningInstancesByTag.instanceIds }}'
    Outputs:
      commandOutputs:
        AggregateType: Fn::ListJoin
        AggregateField: commandOutput
  Outputs:
    commandOutput:
      Type: String
      ValueSelector: invocationOutput
Outputs:
  commandOutputs:
    Type: List
    Value: '{{ runCommand.commandOutputs }}'
